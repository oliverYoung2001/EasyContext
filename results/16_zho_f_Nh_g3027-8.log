+ export CUDA_DEVICE_MAX_CONNECTIONS=1
+ CUDA_DEVICE_MAX_CONNECTIONS=1
+ srun -p arch -N 2 --ntasks-per-node=8 --gres=gpu:8 --mem 256G -K -w g3027,g3028 -c 16 ./scripts/bench_ring_attn.sh python bench_ring_attn.py
srun: job 3669 queued and waiting for resources
srun: job 3669 has been allocated resources
torch distributed is already initialized, skipping initialization ...
************ Finish sequence pralell group Initialization. ***********
Nh=32, S=8192
# zigzag_ring_flash_attn_func, fwd
mfu: 5.724 Tflops/s, hfu: 5.724 Tflops/s, 166.603 iter/s, 0.120 sec
# hierarchy_attn_func, fwd
mfu: 15.077 Tflops/s, hfu: 15.077 Tflops/s, 438.801 iter/s, 0.046 sec
# overlapped_hierarchy_attn_func, fwd
mfu: 15.469 Tflops/s, hfu: 15.469 Tflops/s, 450.202 iter/s, 0.044 sec
Nh=32, S=16384
# zigzag_ring_flash_attn_func, fwd
mfu: 11.986 Tflops/s, hfu: 11.986 Tflops/s, 87.209 iter/s, 0.229 sec
# hierarchy_attn_func, fwd
mfu: 32.923 Tflops/s, hfu: 32.923 Tflops/s, 239.549 iter/s, 0.083 sec
# overlapped_hierarchy_attn_func, fwd
mfu: 38.166 Tflops/s, hfu: 38.166 Tflops/s, 277.692 iter/s, 0.072 sec
Nh=32, S=32768
# zigzag_ring_flash_attn_func, fwd
mfu: 24.061 Tflops/s, hfu: 24.061 Tflops/s, 43.767 iter/s, 0.457 sec
# hierarchy_attn_func, fwd
mfu: 59.559 Tflops/s, hfu: 59.559 Tflops/s, 108.337 iter/s, 0.185 sec
# overlapped_hierarchy_attn_func, fwd
mfu: 70.226 Tflops/s, hfu: 70.226 Tflops/s, 127.741 iter/s, 0.157 sec
Nh=32, S=65536
# zigzag_ring_flash_attn_func, fwd
mfu: 47.944 Tflops/s, hfu: 47.944 Tflops/s, 21.802 iter/s, 0.917 sec
# hierarchy_attn_func, fwd
mfu: 90.488 Tflops/s, hfu: 90.488 Tflops/s, 41.149 iter/s, 0.486 sec
# overlapped_hierarchy_attn_func, fwd
mfu: 101.297 Tflops/s, hfu: 101.297 Tflops/s, 46.064 iter/s, 0.434 sec
Nh=32, S=131072
# zigzag_ring_flash_attn_func, fwd
mfu: 94.068 Tflops/s, hfu: 94.068 Tflops/s, 10.694 iter/s, 1.870 sec
# hierarchy_attn_func, fwd
mfu: 115.524 Tflops/s, hfu: 115.524 Tflops/s, 13.134 iter/s, 1.523 sec
# overlapped_hierarchy_attn_func, fwd
mfu: 122.444 Tflops/s, hfu: 122.444 Tflops/s, 13.920 iter/s, 1.437 sec
Nh=32, S=262144
# zigzag_ring_flash_attn_func, fwd
mfu: 179.877 Tflops/s, hfu: 179.877 Tflops/s, 5.112 iter/s, 3.912 sec
# hierarchy_attn_func, fwd
mfu: 129.473 Tflops/s, hfu: 129.473 Tflops/s, 3.680 iter/s, 5.435 sec
# overlapped_hierarchy_attn_func, fwd
mfu: 133.745 Tflops/s, hfu: 133.745 Tflops/s, 3.801 iter/s, 5.261 sec
Nh=40, S=8192
# zigzag_ring_flash_attn_func, fwd
mfu: 6.052 Tflops/s, hfu: 6.052 Tflops/s, 140.904 iter/s, 0.142 sec
# hierarchy_attn_func, fwd
mfu: 14.956 Tflops/s, hfu: 14.956 Tflops/s, 348.212 iter/s, 0.057 sec
# overlapped_hierarchy_attn_func, fwd
mfu: 18.825 Tflops/s, hfu: 18.825 Tflops/s, 438.311 iter/s, 0.046 sec
Nh=40, S=16384
# zigzag_ring_flash_attn_func, fwd
mfu: 12.036 Tflops/s, hfu: 12.036 Tflops/s, 70.057 iter/s, 0.285 sec
# hierarchy_attn_func, fwd
mfu: 35.391 Tflops/s, hfu: 35.391 Tflops/s, 206.004 iter/s, 0.097 sec
# overlapped_hierarchy_attn_func, fwd
mfu: 40.712 Tflops/s, hfu: 40.712 Tflops/s, 236.976 iter/s, 0.084 sec
Nh=40, S=32768
# zigzag_ring_flash_attn_func, fwd
mfu: 24.016 Tflops/s, hfu: 24.016 Tflops/s, 34.948 iter/s, 0.572 sec
# hierarchy_attn_func, fwd
mfu: 63.762 Tflops/s, hfu: 63.762 Tflops/s, 92.786 iter/s, 0.216 sec
# overlapped_hierarchy_attn_func, fwd
Nh=80, S=8192
# zigzag_ring_flash_attn_func, fwd
mfu: 6.034 Tflops/s, hfu: 6.034 Tflops/s, 70.241 iter/s, (0.002, 4.586, 0.285) sec
# hierarchy_attn_func, fwd
mfu: 20.088 Tflops/s, hfu: 20.088 Tflops/s, 233.853 iter/s, (0.001, 6.447, 0.086) sec
# overlapped_hierarchy_attn_func, fwd
mfu: 25.162 Tflops/s, hfu: 25.162 Tflops/s, 292.926 iter/s, (0.001, 6.409, 0.068) sec
Nh=80, S=16384
# zigzag_ring_flash_attn_func, fwd
mfu: 12.037 Tflops/s, hfu: 12.037 Tflops/s, 35.032 iter/s, (0.001, 0.167, 0.571) sec
# hierarchy_attn_func, fwd
mfu: 40.859 Tflops/s, hfu: 40.859 Tflops/s, 118.915 iter/s, (0.001, 8.432, 0.168) sec
# overlapped_hierarchy_attn_func, fwd
mfu: 46.663 Tflops/s, hfu: 46.663 Tflops/s, 135.806 iter/s, (0.001, 8.826, 0.147) sec
Nh=80, S=32768
# zigzag_ring_flash_attn_func, fwd
mfu: 24.037 Tflops/s, hfu: 24.037 Tflops/s, 17.489 iter/s, (0.001, 0.311, 1.144) sec
# hierarchy_attn_func, fwd
mfu: 65.873 Tflops/s, hfu: 65.873 Tflops/s, 47.929 iter/s, (0.001, 10.770, 0.417) sec
# overlapped_hierarchy_attn_func, fwd
mfu: 77.243 Tflops/s, hfu: 77.243 Tflops/s, 56.202 iter/s, (0.001, 10.799, 0.356) sec
Nh=80, S=65536
# zigzag_ring_flash_attn_func, fwd
mfu: 47.473 Tflops/s, hfu: 47.473 Tflops/s, 8.635 iter/s, (0.001, 0.623, 2.316) sec
# hierarchy_attn_func, fwd
mfu: 95.42 Tflops/s, hfu: 95.42 Tflops/s, 17.357 iter/s, (0.001, 14.210, 1.152) sec
# overlapped_hierarchy_attn_func, fwd
mfu: 106.082 Tflops/s, hfu: 106.082 Tflops/s, 19.296 iter/s, (0.001, 14.663, 1.036) sec
Nh=80, S=131072
# zigzag_ring_flash_attn_func, fwd
mfu: 90.956 Tflops/s, hfu: 90.956 Tflops/s, 4.136 iter/s, (0.001, 1.244, 4.835) sec
# hierarchy_attn_func, fwd
mfu: 112.9 Tflops/s, hfu: 112.9 Tflops/s, 5.134 iter/s, (0.001, 19.818, 3.896) sec
# overlapped_hierarchy_attn_func, fwd
mfu: 119.961 Tflops/s, hfu: 119.961 Tflops/s, 5.455 iter/s, (0.001, 20.186, 3.666) sec
Nh=80, S=262144
# zigzag_ring_flash_attn_func, fwd
mfu: 177.498 Tflops/s, hfu: 177.498 Tflops/s, 2.018 iter/s, (0.001, 2.521, 9.911) sec
# hierarchy_attn_func, fwd
mfu: 113.563 Tflops/s, hfu: 113.563 Tflops/s, 1.291 iter/s, (0.001, 28.759, 15.491) sec
# overlapped_hierarchy_attn_func, fwd
mfu: 115.269 Tflops/s, hfu: 115.269 Tflops/s, 1.310 iter/s, (0.001, 29.111, 15.262) sec
+ set +x
